@model List<MangaShop.Models.ChiTietDonHang>

@{
    var donHang = ViewBag.DonHang as MangaShop.Models.DonHang;
    var daDanhGiaIds = ViewBag.DaDanhGiaIds as HashSet<int> ?? new HashSet<int>();

    ViewData["Title"] = "Chi tiết đơn hàng";
}

@if (donHang == null)
{
    <div class="alert alert-danger shadow-sm">
        <i class="fa-solid fa-circle-xmark me-2"></i> Không tìm thấy đơn hàng.
    </div>
    <a asp-action="BillUser" class="btn btn-secondary"><i class="fa-solid fa-arrow-left"></i> Quay lại</a>
    return;
}

<h2 class="mb-3 text-uppercase fw-bold text-dark">🧾 Chi tiết đơn hàng #@donHang.MaDonHang</h2>

<div class="row mb-4">
    <div class="col-md-6">
        <p class="mb-1"><strong>Ngày đặt:</strong> @donHang.NgayDat?.ToString("dd/MM/yyyy HH:mm")</p>
        <p class="mb-1"><strong>Phương thức thanh toán:</strong> @(donHang.PhuongThucThanhToan ?? "Chưa xác định")</p>
    </div>
</div>

@* THANH TRẠNG THÁI VÀ LÝ DO HỦY *@
<div class="d-flex justify-content-between align-items-center mb-4 bg-light p-3 rounded border shadow-sm">
    <div style="flex: 1;">
        <strong class="me-2">Trạng thái:</strong>
        @* Kiểm tra nhiều trường hợp để tránh sai sót dữ liệu *@
        @if (donHang.TrangThai == "Huỷ" || donHang.TrangThai == "Hủy" || donHang.TrangThai == "Đã Huỷ" || donHang.TrangThai == "Đã hủy")
        {
            <span class="badge bg-secondary px-3 py-2">Đã hủy</span>
        }
        else if (donHang.TrangThai == "Hoàn thành")
        {
            <span class="badge bg-success px-3 py-2">Hoàn thành</span>
        }
        else
        {
            <span class="badge bg-primary px-3 py-2">@donHang.TrangThai</span>
        }
    </div>

    <div class="text-center px-2" style="flex: 2;">
        @if (donHang.TrangThai == "Huỷ" || donHang.TrangThai == "Hủy" || donHang.TrangThai == "Đã Huỷ" || donHang.TrangThai == "Đã hủy")
        {
            <div class="alert alert-danger mb-0 py-1 border-0 bg-transparent">
                <span class="fw-bold"><i class="fa-solid fa-circle-info"></i> Lý do:</span>
                <span class="fst-italic">@(string.IsNullOrEmpty(donHang.LyDoHuy) ? "Không có lý do chi tiết" : donHang.LyDoHuy)</span>
            </div>
        }
    </div>

    <div class="text-end" style="flex: 1;">
        <a asp-action="BillUser" class="btn btn-outline-secondary shadow-sm">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
    </div>
</div>

@* BẢNG CHI TIẾT SẢN PHẨM *@
<div class="table-responsive shadow-sm rounded">
    <table class="table table-bordered align-middle text-center mb-0">
        <thead class="table-dark">
            <tr>
                <th>Ảnh</th>
                <th class="text-start">Sản phẩm</th>
                <th>Đơn giá</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td style="width:100px">
                        <img src="~/images/@item.MaTruyenNavigation?.AnhBia"
                             style="width:60px; height:80px; object-fit:cover"
                             class="rounded border" />
                    </td>
                    <td class="text-start">
                        <div class="fw-bold text-dark">@item.MaTruyenNavigation?.TenTruyen</div>

                        @if (item.MaTapNavigation != null)
                        {
                            <div class="small text-muted">
                                <i class="fa-solid fa-book-open me-1"></i> Tập đã mua: <b>@item.MaTapNavigation.SoTap</b>
                            </div>
                        }
                    </td>
                    <td>@item.DonGia.ToString("N0") ₫</td>
                    <td>@item.SoLuong</td>
                    <td class="text-danger fw-bold">
                        @((item.DonGia * item.SoLuong).ToString("N0")) ₫
                    </td>
                </tr>

                @* DÒNG ĐÁNH GIÁ *@
                <tr>
                    <td colspan="5" class="text-start bg-light py-2">
                        @if (donHang.TrangThai == "Hoàn thành")
                        {
                            if (!daDanhGiaIds.Contains(item.MaTruyen))
                            {
                                <a asp-controller="DanhGia"
                                   asp-action="Create"
                                   asp-route-maTruyen="@item.MaTruyen"
                                   asp-route-maDonHang="@donHang.MaDonHang"
                                   class="btn btn-sm btn-warning fw-bold shadow-sm">
                                    <i class="fa-solid fa-star me-1"></i> Thêm đánh giá
                                </a>
                            }
                            else
                            {
                                <span class="text-success fw-bold small"><i class="fa-solid fa-check-circle"></i> Bạn đã đánh giá truyện này</span>
                            }
                        }
                        else if (donHang.TrangThai == "Huỷ" || donHang.TrangThai == "Hủy")
                        {
                            <span class="text-muted small italic">Đơn hàng đã hủy, không thể đánh giá.</span>
                        }
                        else
                        {
                            <span class="text-muted small">
                                <i class="fa-solid fa-lock me-1"></i> Đánh giá sẽ mở khi đơn hàng <b>Hoàn thành</b>.
                            </span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* PHẦN TỔNG TIỀN *@
<div class="row mt-4 px-2">
    <div class="col-md-7">
        @if (!string.IsNullOrEmpty(donHang.GhiChu))
        {
            <div class="p-3 bg-light border rounded">
                <h6 class="fw-bold mb-1 font-monospace">Ghi chú của bạn:</h6>
                <div class="small italic text-muted">@donHang.GhiChu</div>
            </div>
        }
    </div>
    <div class="col-md-5 text-end">
        <div class="mb-1 text-muted">Tạm tính: <b>@donHang.TongTien.ToString("N0") ₫</b></div>

        @if (donHang.GiamGiaPhanTram != null && donHang.GiamGiaPhanTram > 0)
        {
            <div class="mb-1 text-success">
                Giảm giá (@donHang.GiamGiaPhanTram%):
                <b>-@((donHang.TienGiam ?? 0).ToString("N0")) ₫</b>
            </div>

            <h3 class="mt-2 text-dark">
                Tổng thanh toán:
                <span class="text-danger fw-bold">@((donHang.TongThanhToan ?? donHang.TongTien).ToString("N0")) ₫</span>
            </h3>
        }
        else
        {
            <h3 class="mt-2 text-dark">
                Tổng thanh toán:
                <span class="text-danger fw-bold">@donHang.TongTien.ToString("N0") ₫</span>
            </h3>
        }
    </div>
</div>