@model MangaShop.Models.ViewModels.CheckoutVM
@{
    ViewData["Title"] = "Thanh toán";

    // 1. Logic Gộp các sản phẩm cùng Mã Tập trước để tránh trùng lặp dòng
    var cleanedCart = Model.Cart
        .GroupBy(x => x.MaTap)
        .Select(g => new
        {
            Info = g.First(),
            SoLuongTong = g.Sum(x => x.SoLuong)
        }).ToList();

    // 2. Nhóm theo Tên Truyện để tạo các khối Dropdown
    var groupedByManga = cleanedCart
        .GroupBy(x => x.Info.TenTruyen)
        .ToList();

    // 3. Tính toán tiền
    var tongTien = cleanedCart.Sum(x => x.Info.Gia * x.SoLuongTong);
    int giamPhanTram = ViewBag.GiamPhanTram ?? 0;
    var tienGiam = Math.Round(tongTien * giamPhanTram / 100.0, 0);
    var tongThanhToanGoc = tongTien - tienGiam;
}

<link rel="stylesheet" href="~/css/Checkout-Thanhtoan.css" />

<div class="container mt-5 mb-5">
    <div class="checkout-header-wrapper mb-4 d-flex justify-content-between align-items-center">
        <h2 class="checkout-title m-0">🧾 XÁC NHẬN THANH TOÁN</h2>
        <a asp-controller="Cart" asp-action="GioHang" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left"></i> Quay lại giỏ hàng
        </a>
    </div>

    <div class="manga-groups-wrapper mb-4">
        @foreach (var mangaGroup in groupedByManga)
        {
            // Tạo ID duy nhất cho mỗi group để đóng mở
            var collapseId = "collapse_" + Guid.NewGuid().ToString("N");
            var totalItemsInGroup = mangaGroup.Sum(x => x.SoLuongTong);

            <div class="card mb-3 shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex align-items-center justify-content-between"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#@collapseId">

                    <div class="d-flex align-items-center">
                        <img src="~/images/@mangaGroup.First().Info.AnhBia" style="width:50px; height:70px; object-fit:cover" class="rounded me-3 border" />
                        <div>
                            <h5 class="m-0 text-success fw-bold">@mangaGroup.Key</h5>
                            <small class="text-muted">Tổng cộng: @totalItemsInGroup tập trong đơn hàng</small>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-down text-muted"></i>
                </div>

                <div id="@collapseId" class="collapse show">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle m-0">
                            <thead class="table-light">
                                <tr class="small text-muted">
                                    <th class="ps-4">SỐ TẬP</th>
                                    <th class="text-center">ĐƠN GIÁ</th>
                                    <th class="text-center">SỐ LƯỢNG</th>
                                    <th class="text-end pe-4">THÀNH TIỀN</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in mangaGroup)
                                {
                                    <tr>
                                        <td class="ps-4 fw-bold">Tập @item.Info.SoTap</td>
                                        <td class="text-center">@item.Info.Gia.ToString("N0") ₫</td>
                                        <td class="text-center">
                                            <span class="badge bg-light text-dark border px-3">@item.SoLuongTong</span>
                                        </td>
                                        <td class="text-end pe-4 fw-bold text-primary">
                                            @((item.Info.Gia * item.SoLuongTong).ToString("N0")) ₫
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    </div>

    <form asp-action="Confirm" method="post" id="checkoutForm">
        @Html.AntiForgeryToken()

        <div class="card border-info mb-4 shadow-sm insurance-card">
            <div class="card-body py-3 d-flex align-items-center justify-content-between">
                <div class="form-check m-0">
                    <input class="form-check-input" type="checkbox" asp-for="CoBaoHiem" id="checkBaoHiem" onchange="updateTotal()">
                    <label class="form-check-label fw-bold text-info" for="checkBaoHiem" style="cursor:pointer">
                        🛡️ Bảo hiểm sản phẩm (+1% giá trị đơn hàng)
                        <div class="small text-muted fw-normal">Đảm bảo đổi trả 1:1 nếu sản phẩm bị hư hại khi vận chuyển.</div>
                    </label>
                </div>
                <span class="badge bg-info text-white px-3 py-2 fs-6" id="phiBaoHiemBadge">0 ₫</span>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-primary text-white fw-bold py-3">THÔNG TIN GIAO HÀNG</div>
                    <div class="card-body border">
                        <div class="mb-3">
                            <label class="form-label">Họ tên người nhận</label>
                            <input asp-for="HoTen" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input asp-for="SoDienThoai" class="form-control" required />
                        </div>
                        <div class="mb-0">
                            <label class="form-label">Địa chỉ chi tiết</label>
                            <textarea asp-for="DiaChi" class="form-control" rows="3" required></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-header bg-dark text-white fw-bold py-3">
                        <i class="fa-solid fa-credit-card me-2"></i> THANH TOÁN
                    </div>
                    <div class="card-body border">
                        <input type="hidden" asp-for="PaymentMethod" id="paymentMethod" value="COD" />

                        <div class="d-grid gap-2 mb-3">
                            <button type="button" class="btn btn-outline-primary text-start btn-pay p-3" onclick="setPay('QR_MOMO', this)">
                                <img src="~/images/logo-momo.png" alt="Momo" class="momo-icon-pay me-2" />
                                Ví MoMo (QR Code)
                            </button>
                            <button type="button" class="btn btn-outline-primary text-start btn-pay p-3" onclick="setPay('VISA', this)">
                                <i class="fa-solid fa-credit-card me-2 fs-5"></i> Thẻ Visa/MasterCard
                            </button>
                            <button type="button" class="btn btn-outline-primary text-start btn-pay p-3 active" onclick="setPay('COD', this)">
                                <i class="fa-solid fa-money-bill-1-wave me-2 fs-5"></i>Thanh toán khi nhận hàng (SHIP-COD)
                            </button>
                        </div>

                        <div id="visaForm" class="p-3 border rounded bg-light mb-3" style="display:none">
                            <h6 class="fw-bold mb-3 text-primary"><i class="fa-brands fa-cc-visa me-1"></i> Thông tin thẻ</h6>
                            <input type="text" id="visaCardNumber" class="form-control mb-2" placeholder="Số thẻ (16 số)" maxlength="16">
                            <div class="row g-2">
                                <div class="col-7"><input type="text" id="visaExpiry" class="form-control" placeholder="MM/YY"></div>
                                <div class="col-5"><input type="password" id="visaCVV" class="form-control" placeholder="CVV"></div>
                            </div>
                            <small id="visaError" class="text-danger mt-2 d-none">⚠️ Vui lòng điền đủ thông tin!</small>
                        </div>
                        <div id="momoQR" class="text-center p-3 border rounded mb-3" style="display:none">
                            <h6 class="fw-bold text-uppercase" style="color:#ae2070">Quét mã MoMo</h6>
                            <img id="momoQRImage" src="" class="img-fluid mb-2" style="max-width: 150px; border: 4px solid #ae2070; border-radius: 10px;">
                            <p class="small mb-1">Số tiền: <b id="momoAmountText" class="text-danger">0 ₫</b></p>
                        </div>

                        <div class="payment-summary mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Tạm tính:</span>
                                <span class="fw-bold">@tongTien.ToString("N0") ₫</span>
                            </div>
                            <div id="rowBaoHiem" class="d-none justify-content-between mb-2 text-info">
                                <span>Phí bảo hiểm (1%):</span>
                                <span class="fw-bold">+<span id="phiBaoHiemValue">0</span> ₫</span>
                            </div>
                            @if (giamPhanTram > 0)
                            {
                                <div class="d-flex justify-content-between mb-2 text-success">
                                    <span>Ưu đãi hạng (@giamPhanTram%):</span>
                                    <span class="fw-bold">-@tienGiam.ToString("N0") ₫</span>
                                </div>
                            }
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h5 fw-bold m-0">TỔNG CỘNG:</span>
                                <span class="h4 text-danger fw-bold m-0" id="finalTotal">@tongThanhToanGoc.ToString("N0") ₫</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100 mt-4 fw-bold py-3 shadow">
                            ĐẶT HÀNG 
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        function setPay(method, btn) {
            document.getElementById("paymentMethod").value = method;
            document.querySelectorAll('.btn-pay').forEach(b => {
                b.classList.remove('active', 'btn-primary', 'text-white');
                b.classList.add('btn-outline-primary');
            });
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('active', 'btn-primary', 'text-white');

            document.getElementById("visaForm").style.display = (method === 'VISA') ? "block" : "none";
            document.getElementById("momoQR").style.display = (method === 'QR_MOMO') ? "block" : "none";

            if (method === 'QR_MOMO') generateMomoQR();
        }

        function generateMomoQR() {
            const amount = document.getElementById("finalTotal").innerText.replace(/[^0-9]/g, '');
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=MangaShop_Pay_${amount}`;
            document.getElementById("momoQRImage").src = qrUrl;
            document.getElementById("momoAmountText").innerText = Number(amount).toLocaleString() + " ₫";
        }

        function updateTotal() {
            const tamTinh = @tongTien;
            const giamGia = @tienGiam;
            const isChecked = document.getElementById("checkBaoHiem").checked;
            const phiBaoHiem = isChecked ? Math.round(tamTinh * 0.01) : 0;
            const tongCuoi = tamTinh - giamGia + phiBaoHiem;

            document.getElementById("phiBaoHiemBadge").innerText = phiBaoHiem.toLocaleString() + " ₫";
            document.getElementById("phiBaoHiemValue").innerText = phiBaoHiem.toLocaleString();

            const rowBH = document.getElementById("rowBaoHiem");
            if(isChecked) {
                rowBH.classList.remove('d-none');
                rowBH.classList.add('d-flex');
            } else {
                rowBH.classList.add('d-none');
                rowBH.classList.remove('d-flex');
            }

            document.getElementById("finalTotal").innerText = tongCuoi.toLocaleString() + " ₫";
            if(document.getElementById("paymentMethod").value === 'QR_MOMO') generateMomoQR();
        }

        document.getElementById("checkoutForm").onsubmit = function(e) {
            if (document.getElementById("paymentMethod").value === 'VISA') {
                const card = document.getElementById("visaCardNumber").value.trim();
                if (card.length < 16) {
                    e.preventDefault();
                    document.getElementById("visaError").classList.remove('d-none');
                    alert("Vui lòng nhập đúng thông tin thẻ!");
                    return false;
                }
            }
            return true;
        };

        window.onload = updateTotal;
    </script>
}