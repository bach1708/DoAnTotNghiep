@model List<MangaShop.Models.ViewModels.NhapKhoTapTruyenVM>

@{
    ViewData["Title"] = "Nhập kho theo tập";
    Layout = "_AdminLayout";
}

<link rel="stylesheet" href="~/css/NvbTruyen-NhapKhoTap.css" />

<div class="main-wrapper">
    <div class="admin-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="page-title">Nhập kho theo tập</h2>
                <p class="text-muted small mb-0">Hệ thống quản lý nhập liệu tồn kho chi tiết</p>
            </div>
            <div class="action-group">
                <a asp-action="Index" class="btn btn-secondary">Hủy bỏ</a>
            </div>
        </div>

        <form asp-action="NhapKhoTap" method="post">
            @Html.AntiForgeryToken()

            <div class="accordion accordion-dark" id="nhapKhoTapAccordion">
                @for (int i = 0; i < Model.Count; i++)
                {
                    var collapseId = $"collapse_{i}";
                    var headingId = $"heading_{i}";

                    <input type="hidden" asp-for="@Model[i].MaTruyen" />

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="@headingId">
                            <button class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId"
                                    aria-expanded="false"
                                    aria-controls="@collapseId">

                                <div class="d-flex align-items-center gap-3">
                                    <img src="~/images/@Model[i].AnhBia" class="img-manga-mini" />
                                    <div>
                                        <div class="manga-title-acc">@Model[i].TenTruyen</div>
                                        <div class="manga-info-acc">Sẵn có: @(Model[i].Taps?.Count ?? 0) tập</div>
                                    </div>
                                </div>
                            </button>
                        </h2>

                        <div id="@collapseId" class="accordion-collapse collapse" data-bs-parent="#nhapKhoTapAccordion">
                            <div class="accordion-body p-0">
                                @if (Model[i].Taps == null || Model[i].Taps.Count == 0)
                                {
                                    <div class="p-3 text-warning small">Chưa có dữ liệu tập cho bộ truyện này.</div>
                                }
                                else
                                {
                                    <table class="table table-dark-sub m-0">
                                        <thead>
                                            <tr>
                                                <th>Số tập</th>
                                                <th class="text-center">Tồn kho</th>
                                                <th class="text-center" style="width:250px">Số lượng nhập thêm</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (int j = 0; j < Model[i].Taps.Count; j++)
                                            {
                                                <tr>
                                                    <td class="ps-4">
                                                        Tập @Model[i].Taps[j].SoTap
                                                        <input type="hidden" asp-for="@Model[i].Taps[j].MaTap" />
                                                        <input type="hidden" asp-for="@Model[i].Taps[j].SoTap" />
                                                        <input type="hidden" asp-for="@Model[i].Taps[j].SoLuongTon" />
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="text-info">@Model[i].Taps[j].SoLuongTon</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="qty-control">
                                                            <button type="button" class="btn-qty" onclick="changeQty(@i, @j, -1)">−</button>
                                                            <input asp-for="@Model[i].Taps[j].SoLuongNhap"
                                                                   type="number" min="0" value="0" id="qty_@(i)_@(j)"
                                                                   class="input-qty" />
                                                            <button type="button" class="btn-qty" onclick="changeQty(@i, @j, 1)">+</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="sticky-footer">
                <button type="submit" class="btn btn-success px-5 shadow-lg">Xác nhận nhập kho</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function changeQty(i, j, delta) {
            const input = document.getElementById(`qty_${i}_${j}`);
            const current = parseInt(input.value || "0", 10);
            let next = current + delta;
            if (next < 0) next = 0;
            input.value = next;
        }
    </script>
}