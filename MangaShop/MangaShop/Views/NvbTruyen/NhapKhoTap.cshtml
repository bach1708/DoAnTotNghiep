@model List<MangaShop.Models.ViewModels.NhapKhoTapTruyenVM>

@{
    ViewData["Title"] = "Nhập kho theo tập";
    Layout = "_AdminLayout";
}

<link rel="stylesheet" href="~/css/NvbTruyen-NhapKhoTap.css" />

<div class="main-wrapper">
    <div class="admin-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="page-title">Nhập kho theo tập</h2>
                <p class="text-muted small mb-0">Hệ thống quản lý nhập liệu tồn kho chi tiết</p>
            </div>
            <div class="action-group d-flex gap-2">
                <a asp-action="LichSuNhap" class="btn btn-outline-dark">
                    <i class="fa-solid fa-clock-rotate-left me-1"></i> Lịch sử
                </a>
                <a asp-action="Index" class="btn btn-secondary"> <i class="fa-solid fa-arrow-left"></i></a>
            </div>
        </div>

        <form asp-action="NhapKhoTap" method="post" id="formNhapKho">
            @Html.AntiForgeryToken()

            <div asp-validation-summary="ModelOnly" class="alert alert-danger shadow-sm mb-4 fw-bold"></div>

            <div class="accordion accordion-dark" id="nhapKhoTapAccordion">
                @for (int i = 0; i < Model.Count; i++)
                {
                    var collapseId = $"collapse_{i}";
                    var headingId = $"heading_{i}";

                    <input type="hidden" asp-for="@Model[i].MaTruyen" />
                    <input type="hidden" asp-for="@Model[i].TenTruyen" />
                    <input type="hidden" asp-for="@Model[i].AnhBia" />

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="@headingId">
                            <button class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#@collapseId"
                                    aria-expanded="false"
                                    aria-controls="@collapseId">

                                <div class="d-flex align-items-center gap-3">
                                    <img src="~/images/@Model[i].AnhBia" class="img-manga-mini" onerror="this.src='/images/no-image.png'" />
                                    <div>
                                        <div class="manga-title-acc">@Model[i].TenTruyen</div>
                                        <div class="manga-info-acc">Sẵn có: @(Model[i].Taps?.Count ?? 0) tập</div>
                                    </div>
                                </div>
                            </button>
                        </h2>

                        <div id="@collapseId" class="accordion-collapse collapse" data-bs-parent="#nhapKhoTapAccordion">
                            <div class="accordion-body p-0">
                                @if (Model[i].Taps == null || Model[i].Taps.Count == 0)
                                {
                                    <div class="p-3 text-warning small italic">Chưa có dữ liệu tập cho bộ truyện này.</div>
                                }
                                else
                                {
                                    <table class="table table-dark-sub m-0">
                                        <thead>
                                            <tr>
                                                <th class="ps-4">Số tập</th>
                                                <th class="text-center">Tồn kho hiện tại</th>
                                                <th class="text-center" style="width:250px">Số lượng nhập thêm</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (int j = 0; j < Model[i].Taps.Count; j++)
                                            {
                                                <tr>
                                                    <td class="ps-4">
                                                        <span class="fw-600">Tập @Model[i].Taps[j].SoTap</span>
                                                        <input type="hidden" asp-for="@Model[i].Taps[j].MaTap" />
                                                        <input type="hidden" asp-for="@Model[i].Taps[j].SoTap" />
                                                        <input type="hidden" asp-for="@Model[i].Taps[j].SoLuongTon" />
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-light text-dark border">@Model[i].Taps[j].SoLuongTon</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="qty-control mx-auto">
                                                            <button type="button" class="btn-qty" onclick="changeQty(@i, @j, -1)">−</button>
                                                            <input asp-for="@Model[i].Taps[j].SoLuongNhap"
                                                                   type="number" min="0" value="0" id="qty_@(i)_@(j)"
                                                                   class="input-qty" oninput="updateSubmitButton()" />
                                                            <button type="button" class="btn-qty" onclick="changeQty(@i, @j, 1)">+</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="sticky-footer">
                <span id="total-summary" class="me-auto small text-muted d-none d-md-block">
                    Vui lòng nhập số lượng để bắt đầu...
                </span>
                <button type="submit" id="btnSubmitNhapKho" class="btn btn-success px-5 shadow-lg">
                    Xác nhận nhập kho
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        /**
         * Hàm thay đổi số lượng khi nhấn nút cộng/trừ
         */
        function changeQty(i, j, delta) {
            const input = document.getElementById(`qty_${i}_${j}`);
            let current = parseInt(input.value || "0", 10);
            let next = current + delta;

            if (next < 0) next = 0;
            input.value = next;

            // Cập nhật trạng thái nút sau khi thay đổi
            updateSubmitButton();
        }

        /**
         * Hàm kiểm tra tổng số lượng nhập để bật/tắt nút Xác nhận
         */
        function updateSubmitButton() {
            let totalQty = 0;
            const inputs = document.querySelectorAll('.input-qty');

            inputs.forEach(input => {
                totalQty += parseInt(input.value || "0", 10);
            });

            const btn = document.getElementById('btnSubmitNhapKho');
            const summary = document.getElementById('total-summary');

            if (totalQty > 0) {
                // Có hàng: Bật nút
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
                if (summary) summary.innerHTML = `<i class="fa-solid fa-check-circle text-success me-1"></i> Tổng cộng sẽ nhập: <strong>${totalQty}</strong> quyển`;
            } else {
                // Không có hàng: Khóa nút
                btn.disabled = true;
                btn.style.opacity = "0.5";
                btn.style.cursor = "not-allowed";
                if (summary) summary.innerText = "Chưa có tập nào được chọn để nhập.";
            }
        }

        // Chạy kiểm tra ngay khi trang tải xong
        document.addEventListener("DOMContentLoaded", function() {
            updateSubmitButton();

            // Đảm bảo Validation Summary biến mất sau vài giây nếu muốn (tùy chọn)
            const valSum = document.querySelector('[asp-validation-summary]');
            if (valSum && valSum.innerText.trim() !== "") {
                setTimeout(() => {
                    valSum.style.display = 'none';
                }, 8000);
            }
        });
    </script>
}